# 地图文件格式说明

本文档说明MAPF-AGV项目支持的地图文件格式。

## 支持的格式

项目支持三种地图文件格式：

1. **JSON格式** (`.json`) - 推荐，人类可读，易于调试
2. **XML格式** (`.xml`) - 结构化，易于解析
3. **二进制格式** (`.map`) - 文件小，加载快

## 格式对比

| 特性 | JSON | XML | 二进制 |
|------|------|-----|--------|
| 人类可读 | ✅ 是 | ✅ 是 | ❌ 否 |
| 文件大小 | 中等 | 较大 | 最小 |
| 加载速度 | 快 | 中等 | 最快 |
| 编辑难度 | 容易 | 中等 | 困难 |
| 兼容性 | 好 | 好 | 一般 |
| 推荐场景 | 开发调试 | 配置文件 | 生产环境 |

## 1. JSON格式 (推荐)

### 文件扩展名
`.json`

### 优点
- ✅ 人类可读，易于调试
- ✅ 易于版本控制（Git友好）
- ✅ 跨平台兼容性好
- ✅ 易于手动编辑

### 缺点
- ❌ 文件大小较大
- ❌ 解析速度略慢于二进制

### 示例文件结构

```json
{
  "version": "1.0",
  "pointCount": 3,
  "edgeCount": 2,
  "points": [
    {
      "name": "起点",
      "id": 1,
      "x": 10.0,
      "y": 10.0,
      "theta": 0.0,
      "type": 1
    },
    {
      "name": "工位1",
      "id": 2,
      "x": 30.0,
      "y": 20.0,
      "theta": 1.57,
      "type": 0
    },
    {
      "name": "休息点",
      "id": 3,
      "x": 40.0,
      "y": 40.0,
      "theta": 3.14,
      "type": 2
    }
  ],
  "edges": [
    {
      "startId": 1,
      "startName": "起点",
      "endId": 2,
      "endName": "工位1",
      "navMode": 0,
      "driveMode": 0
    },
    {
      "startId": 2,
      "startName": "工位1",
      "endId": 3,
      "endName": "休息点",
      "navMode": 0,
      "driveMode": 1
    }
  ]
}
```

### 字段说明

**点位类型 (type)**:
- `0`: 工位点 (POINT_WORKSTATION)
- `1`: 路径点 (POINT_PATH)
- `2`: 休息点 (POINT_REST)

**导航模式 (navMode)**:
- `0`: 前进 (NAV_FORWARD)
- `1`: 后退 (NAV_BACKWARD)

**行驶模式 (driveMode)**:
- `0`: 直线 (DRIVE_STRAIGHT)
- `1`: 曲线 (DRIVE_CURVE)

---

## 2. XML格式

### 文件扩展名
`.xml`

### 优点
- ✅ 结构化，易于解析
- ✅ 支持注释
- ✅ 易于验证（XSD/DTD）

### 缺点
- ❌ 文件大小较大
- ❌ 语法较复杂

### 示例文件结构

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MapData version="1.0">
  <Points>
    <Point id="1" name="起点" x="10.0" y="10.0" theta="0.0" type="1"/>
    <Point id="2" name="工位1" x="30.0" y="20.0" theta="1.57" type="0"/>
    <Point id="3" name="休息点" x="40.0" y="40.0" theta="3.14" type="2"/>
  </Points>
  <Edges>
    <Edge startId="1" startName="起点" endId="2" endName="工位1" 
          navMode="0" driveMode="0"/>
    <Edge startId="2" startName="工位1" endId="3" endName="休息点" 
          navMode="0" driveMode="1"/>
  </Edges>
</MapData>
```

---

## 3. 二进制格式

### 文件扩展名
`.map`

### 优点
- ✅ 文件大小最小
- ✅ 加载速度最快
- ✅ 适合生产环境

### 缺点
- ❌ 人类不可读
- ❌ 不易调试
- ❌ 不易版本控制

### 文件结构

```
文件头: "MAPDATA_V1.0" (字符串)
点位数量: uint32
点位数据:
  - 名称 (QString)
  - ID (int32)
  - X坐标 (double)
  - Y坐标 (double)
  - 角度 (double)
  - 类型 (uint32)
边数量: uint32
边数据:
  - 起点ID (int32)
  - 起点名称 (QString)
  - 终点ID (int32)
  - 终点名称 (QString)
  - 导航模式 (uint32)
  - 行驶模式 (uint32)
```

---

## 格式选择建议

### 开发阶段
- **推荐**: JSON格式
- **原因**: 易于调试，可以手动编辑，Git友好

### 测试阶段
- **推荐**: JSON或XML格式
- **原因**: 可以验证数据正确性

### 生产环境
- **推荐**: 二进制格式
- **原因**: 文件小，加载快，性能好

### 配置文件
- **推荐**: XML格式
- **原因**: 结构化，支持注释，易于验证

---

## 数据验证

所有格式在加载时都会进行验证：

1. **点位验证**:
   - ID必须唯一
   - 坐标必须在合理范围内
   - 类型必须是有效值

2. **边验证**:
   - 起点和终点必须存在
   - 不能有重复的边（相同起点和终点）

3. **完整性验证**:
   - 所有边的起点和终点必须对应存在的点位

---

## 版本兼容性

当前版本: **1.0**

未来版本更新时，会保持向后兼容：
- 旧版本文件可以加载（忽略新字段）
- 新版本文件会标记版本号，旧版本可以提示升级

---

## 使用示例

### 在代码中加载地图

```cpp
MapData mapData;

// 加载JSON格式
if (mapData.loadFromJson("map.json")) {
    qDebug() << "地图加载成功，包含" << mapData.getPointCount() << "个点位";
}

// 保存为二进制格式
mapData.saveToBinary("map.map");
```

### 在编辑器中

1. 打开地图编辑器
2. 选择"读取地图"
3. 选择文件格式（JSON/XML/二进制）
4. 编辑点位和边
5. 选择"保存地图"或"另存为"
6. 选择保存格式

---

## 文件命名建议

- JSON格式: `map.json`, `warehouse_map.json`
- XML格式: `map.xml`, `warehouse_map.xml`
- 二进制格式: `map.map`, `warehouse_map.map`

建议使用描述性的文件名，如：
- `warehouse_floor1.json`
- `production_line_map.xml`
- `agv_navigation.map`


