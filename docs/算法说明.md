# AGV车辆运动控制算法说明

本文档详细说明项目中实现的4种车辆运动控制算法及其数学公式。

## 算法概述

项目实现了5种控制算法，适用于不同的应用场景：

1. **先旋转再前进** - 简单分段控制
2. **边旋转边前进** - 同时控制
3. **PID控制** - 成熟的双PID控制器（含积分抗饱和）
4. **Pure Pursuit** - 纯跟踪算法（适合路径跟踪）
5. **Stanley** - 横向误差+航向误差控制，精度最优
6. **滑模/切换控制** - 全姿态可达（推荐）

---

## 算法1：先旋转再前进

### 控制逻辑
- 当角度误差 > 阈值时：原地旋转（v=0, ω≠0）
- 当角度误差 ≤ 阈值时：前进并微调（v≠0, ω用于微调）

### 公式
```
角度误差: e_θ = atan2(Δy, Δx) - θ
距离误差: e_d = √(Δx² + Δy²)

if |e_θ| > 阈值:
    v = 0
    ω = K_θ * e_θ
else:
    v = K_p * e_d
    ω = K_θ * e_θ
```

### 特点
- ✅ 路径简单直观
- ✅ 适合精确导航
- ❌ 效率较低（需要原地旋转）

---

## 算法2：边旋转边前进

### 控制逻辑
- 同时控制线速度和角速度
- 根据角度误差动态调整线速度
- 智能选择前进/后退

### 公式
```
角度误差: e_θ = atan2(Δy, Δx) - θ
距离误差: e_d = √(Δx² + Δy²)

期望速度: v_desired = K_p * e_d
速度衰减: v = v_desired * (1 - |e_θ|/π)  [当|e_θ| > 60°时]

角速度: ω = K_θ * e_θ

前进/后退判断:
    if |e_θ| < 90°: v > 0 (前进)
    else: v < 0 (后退)
```

### 特点
- ✅ 运动流畅
- ✅ 效率高
- ❌ 路径可能更复杂

---

## 算法3：PID控制（推荐）⭐

### 算法原理
使用**两个独立的PID控制器**分别控制线速度和角速度，这是工业界最常用的控制方法。

### 数学公式

#### 1. 位置误差计算
```
距离误差: e_d = √((x_goal - x)² + (y_goal - y)²)
角度误差: e_θ = atan2(y_goal - y, x_goal - x) - θ
```

#### 2. 线速度PID控制
```
PID公式: v = Kp_v * e_d + Ki_v * ∫e_d*dt + Kd_v * de_d/dt

其中:
- Kp_v: 比例增益（快速响应）
- Ki_v: 积分增益（消除稳态误差）
- Kd_v: 微分增益（减少超调）
- ∫e_d*dt: 误差积分项
- de_d/dt: 误差变化率
```

#### 3. 角速度PID控制
```
PID公式: ω = Kp_ω * e_θ + Ki_ω * ∫e_θ*dt + Kd_ω * de_θ/dt

其中:
- Kp_ω: 角度比例增益
- Ki_ω: 角度积分增益
- Kd_ω: 角度微分增益
```

#### 4. 速度调整
```
当角度误差较大时，降低线速度:
v_adjusted = v * cos(|e_θ|)  [当|e_θ| > 45°时]
```

#### 5. 运动学更新
```
x(t+1) = x(t) + v * cos(θ) * Δt
y(t+1) = y(t) + v * sin(θ) * Δt
θ(t+1) = θ(t) + ω * Δt
```

### 实现细节
- **积分项限制**：防止积分饱和
- **微分项平滑**：使用低通滤波
- **速度限制**：确保在物理约束内

### 特点
- ✅ 控制精度高
- ✅ 响应快速
- ✅ 稳定性好
- ✅ 工业标准算法

---

## 算法4：Pure Pursuit（纯跟踪算法）

### 算法原理
Pure Pursuit是一种**几何路径跟踪算法**，通过计算前瞻点（lookahead point）来控制车辆转向。

### 数学公式

#### 1. 前瞻距离计算
```
动态前瞻距离: ld = ld_base * (1 + v/v_max)
限制范围: ld_min ≤ ld ≤ ld_max

其中:
- ld_base: 基础前瞻距离（1.5m）
- v: 当前速度
- v_max: 最大速度
```

#### 2. 前瞻点计算
```
到目标距离: d = √((x_goal - x)² + (y_goal - y)²)

if d ≤ ld:
    前瞻点 = 目标点
else:
    前瞻点 = 当前位置 + (目标点 - 当前位置) * (ld / d)
```

#### 3. Pure Pursuit控制律
```
横向误差角: α = atan2(y_lookahead - y, x_lookahead - x) - θ

线速度: v = K_p * distance  [根据距离调整]

角速度: ω = (2 * v * sin(α)) / ld

其中:
- α: 前瞻点与车辆朝向的夹角
- ld: 前瞻距离
- sin(α): 横向误差的正弦值
```

#### 4. 几何关系
```
前瞻点、车辆中心、车辆朝向构成一个三角形
转向半径: R = ld / (2 * sin(α))
角速度: ω = v / R = (2 * v * sin(α)) / ld
```

### 特点
- ✅ 路径跟踪平滑
- ✅ 适合路径规划
- ✅ 几何直观
- ✅ 广泛应用于自动驾驶

---

## 车辆运动学模型

所有算法都基于**差分驱动模型**（Differential Drive Model）：

### 运动学方程
```
ẋ = v * cos(θ)
ẏ = v * sin(θ)
θ̇ = ω

离散化（欧拉法）:
x(t+Δt) = x(t) + v * cos(θ) * Δt
y(t+Δt) = y(t) + v * sin(θ) * Δt
θ(t+Δt) = θ(t) + ω * Δt
```

### 圆弧运动（当ω≠0时）
```
转向半径: R = v / ω
圆心: (x_c, y_c) = (x - R*sin(θ), y + R*cos(θ))

x(t+Δt) = x_c + R * sin(θ + ω*Δt)
y(t+Δt) = y_c - R * cos(θ + ω*Δt)
θ(t+Δt) = θ(t) + ω * Δt
```

---

## 参数调优建议

### PID控制参数
- **Kp_v = 1.5**: 线速度比例增益（可调范围：1.0-3.0）
- **Kd_v = 0.3**: 线速度微分增益（可调范围：0.1-0.5）
- **Kp_ω = 2.5**: 角速度比例增益（可调范围：2.0-4.0）
- **Kd_ω = 0.5**: 角速度微分增益（可调范围：0.3-0.8）

### Pure Pursuit参数
- **lookaheadDistance = 1.5m**: 基础前瞻距离
- **minLookahead = 0.5m**: 最小前瞻（低速时）
- **maxLookahead = 3.0m**: 最大前瞻（高速时）

---

## 算法5：Stanley（精度最优）⭐

### 算法原理

Stanley 控制律结合**航向误差**与**横向误差**，常用于自动驾驶路径跟踪，对点对点导航同样有效。

### 数学公式

```
转向角: δ = θ_e + atan(k·e/v)
其中: θ_e = 航向误差, e = distance·sin(θ_e) 为横向误差
角速度: ω = v·tan(δ)/L
```

### 特点

- ✅ 横向误差与航向误差联合补偿
- ✅ 低速时 atan 项增强纠偏
- ✅ 精度高，适合对位要求严格的场景

---

## 算法选择指南

| 算法 | 适用场景 | 优点 | 缺点 |
|------|---------|------|------|
| 先旋转再前进 | 精确导航、狭窄空间 | 路径简单、精确 | 效率低 |
| 边旋转边前进 | 快速导航、开阔空间 | 效率高、流畅 | 路径复杂 |
| PID控制 | 通用场景 | 精度高、稳定 | 需要调参 |
| Pure Pursuit | 路径跟踪、自动驾驶 | 跟踪平滑 | 需要路径点 |
| Stanley | 高精度对位 | 精度最优、响应快 | 需调 k 增益 |
| **滑模/切换** | **任意姿态对位（推荐）** | **全可达、倒退+转向** | 参数较多 |

---

## 算法6：滑模/切换控制（全姿态可达）

### 算法原理

参考**非完整系统不连续控制**与**极坐标滑模**思路，通过**相位切换**实现任意 (x, y, θ) 镇定。因 Brockett 定理，非完整系统无法用光滑时不变反馈镇定，故采用**不连续/切换**策略。

### 相位状态机

| 相位 | 条件 | 动作 |
|------|------|------|
| APPROACH | 默认 | Stanley 接近目标 |
| ANGLE_ADJUST | ρ < posTol 且 \|θe\| 较小 | 蠕行调角 |
| BACK_OFF | \|θe\| 大或调角漂移 | 后退腾出转向空间 |
| TURN | 后退完成 | 蠕行转向至目标角度 |
| RE_APPROACH | 转向完成 | 再次接近目标 |

### 关键参数

- `slideBackOffDist`: 后退距离，需 ≥ 最小转向半径量级
- `slideTurnAngleThresh`: 超过此角度误差直接进入后退
- `slideDriftTol`: 蠕行调角时位置漂移容忍

### 特点

- ✅ 任意 (x, y, θ) 可达
- ✅ 自动选择前进/后退/转向组合
- ✅ 适用于倒车、侧方停车等复杂对位

---

## 参考文献

1. **PID控制理论** - 经典控制理论
2. **Pure Pursuit算法** - R. Craig Coulter, "Implementation of the Pure Pursuit Path Tracking Algorithm"
3. **车辆运动学模型** - 机器人学基础

---

## 代码实现位置

- **控制器类**: `src/controller.h` / `src/controller.cpp`
- **车辆类**: `src/vehicle.h` / `src/vehicle.cpp`
- **算法切换**: `src/mainwindow.cpp` (算法下拉菜单)

