# 4轮车运动学模型说明

本文档详细说明项目中使用的**传统4轮Ackermann转向运动学模型**（Ackermann Steering Model），这是汽车/AGV的标准物理模型，符合实际转向约束。

---

## 模型概述

### 为什么使用Ackermann模型？

4轮车（如汽车、AGV）通常采用**前轮转向、后轮驱动**的结构。Ackermann转向模型准确描述了这种结构的运动学特性，比简单的差分驱动模型更符合物理实际。

### 模型特点

- ✅ **符合物理实际**：基于真实的4轮车前轮转向、后轮驱动机制
- ✅ **考虑轴距约束**：转向半径 R = L/tan(δ)，受轴距和转向角限制
- ✅ **转向角限制**：前轮转向角有物理限制（通常±30度）
- ✅ **非完整约束**：车辆不能横向移动、**无法原地转向**
- ✅ **正确参考点**：以后轴中心为运动学参考，车辆中心由后轴位置还原

---

## Ackermann转向模型

### 1. 车辆结构

```
        前轮（转向）
        /    \
       /      \
      /        \
     /          \
    /            \
   /              \
  /                \
 /                  \
|                    |
|      车辆中心      |
|                    |
|                    |
 \                  /
  \                /
   \              /
    \            /
     \          /
      \        /
       \      /
        \    /
        后轮（驱动）
```

- **L**: 轴距（wheelbase）- 前后轮中心距离
- **δ**: 前轮转向角（steering angle）
- **v**: 后轮中心速度（线速度）
- **θ**: 车辆朝向角

### 2. 运动学方程

#### 连续时间模型

```
ẋ = v * cos(θ)
ẏ = v * sin(θ)
θ̇ = (v * tan(δ)) / L
```

其中：
- `ẋ`, `ẏ`: 车辆中心在x、y方向的速度
- `θ̇`: 车辆朝向角速度
- `v`: 后轮中心线速度
- `δ`: 前轮转向角
- `L`: 轴距

#### 离散时间模型（数值积分）

```
x(t+Δt) = x(t) + v * cos(θ) * Δt
y(t+Δt) = y(t) + v * sin(θ) * Δt
θ(t+Δt) = θ(t) + (v * tan(δ) / L) * Δt
```

### 3. 转向半径

#### 瞬时转向半径

```
R = L / tan(δ)
```

当转向角δ很小时，可以近似为：
```
R ≈ L / δ
```

#### 角速度与转向角的关系

```
ω = θ̇ = (v * tan(δ)) / L
```

因此，给定线速度v和转向角δ，可以计算角速度：
```
ω = (v * tan(δ)) / L
```

反过来，给定线速度v和角速度ω，可以计算转向角：
```
δ = atan(ω * L / v)
```

### 4. 圆弧运动

当车辆转向时（δ ≠ 0），车辆绕**瞬时转向中心（ICR - Instantaneous Center of Rotation）**做圆弧运动。

#### ICR位置

在车辆坐标系中（以车辆中心为原点，朝向为x轴正方向）：
```
ICR_local = (0, R) = (0, L / tan(δ))
```

在世界坐标系中：
```
ICR_world = (x - R*sin(θ), y + R*cos(θ))
```

#### 圆弧运动更新

```
R = v / ω = L / tan(δ)

绕ICR旋转角度: Δθ = ω * Δt

新位置:
x_new = ICR_x + (x_old - ICR_x) * cos(Δθ) - (y_old - ICR_y) * sin(Δθ)
y_new = ICR_y + (x_old - ICR_x) * sin(Δθ) + (y_old - ICR_y) * cos(Δθ)
θ_new = θ_old + Δθ
```

---

## 物理约束

### 1. 转向角限制

实际车辆的前轮转向角有物理限制：
```
-δ_max ≤ δ ≤ δ_max
```

通常：
- 乘用车：±30度（±0.5236 rad）
- AGV：±45度（±0.7854 rad）

### 2. 速度限制

```
-v_max ≤ v ≤ v_max
```

### 4. 无法原地转向（关键物理约束）

传统4轮车**不能原地转向**（与差速/麦克纳姆轮不同）。当线速度 v≈0 且需要转向时，系统采用**最小蠕行速度**（minCreepVelocity）进行近似，实现“准原地”的极小半径转向，既满足物理约束，又兼容原有控制接口。

### 5. 角速度限制（由转向角和速度决定）

```
ω_max = (v * tan(δ_max)) / L
```

因此，给定线速度v时，角速度不能超过：
```
|ω| ≤ (|v| * tan(δ_max)) / L
```

---

## 与差分驱动模型的对比

### 差分驱动模型（旧实现）

```
ẋ = v * cos(θ)
ẏ = v * sin(θ)
θ̇ = ω  (直接给定角速度)
```

**问题**：
- ❌ 没有考虑轴距约束
- ❌ 角速度与线速度没有物理关系
- ❌ 不符合4轮车的实际转向机制

### Ackermann模型（新实现）

```
ẋ = v * cos(θ)
ẏ = v * sin(θ)
θ̇ = (v * tan(δ)) / L
```

**优势**：
- ✅ 考虑轴距L的物理约束
- ✅ 角速度与线速度、转向角有明确的物理关系
- ✅ 符合4轮车的实际转向机制
- ✅ 可以限制转向角，更真实

---

## 代码实现

### 接口1：基于(v,ω)（兼容控制器）

```cpp
void Vehicle::update(double dt, double v, double omega) {
    // 物理约束：v≈0且ω≠0时，采用最小蠕行速度
    if (|v| < ε && |ω| > ε) v = sign(ω) * minCreepVelocity;
    
    // 角速度转转向角：δ = atan(ω·L/v)
    double delta = atan(omega * wheelbase / v);
    updateWithSteering(dt, v, delta);
}
```

### 接口2：基于转向角（更符合物理）

```cpp
void Vehicle::updateWithSteering(double dt, double v, double delta) {
    // 限制转向角
    delta = clamp(delta, -maxSteeringAngle, maxSteeringAngle);
    
    // 计算角速度
    double omega = (v * tan(delta)) / wheelbase;
    
    // 更新位置（圆弧运动）
    // ...
}
```

---

## 参数设置

### 车辆参数（VehicleProperties）

```cpp
double wheelbase = 1.5;          // 轴距 (m)
double maxSteeringAngle = 0.5236;  // 最大转向角 (rad) = 30度
double maxSpeed = 2.0;            // 最大速度 (m/s)
```

### 典型值

| 车辆类型 | 轴距 (m) | 最大转向角 (度) | 最大速度 (m/s) |
|---------|---------|---------------|--------------|
| 小型AGV | 1.0-1.5 | 30-45 | 1.0-2.0 |
| 中型AGV | 1.5-2.0 | 25-35 | 2.0-3.0 |
| 大型AGV | 2.0-3.0 | 20-30 | 3.0-5.0 |

---

## 数学验证

### 验证1：直线运动

当δ = 0时：
```
ω = (v * tan(0)) / L = 0
```

车辆做直线运动，符合预期。

### 验证2：最小转向半径

当δ = δ_max时：
```
R_min = L / tan(δ_max)
```

例如：L = 1.5m, δ_max = 30° = 0.5236 rad
```
R_min = 1.5 / tan(0.5236) ≈ 1.5 / 0.577 ≈ 2.6 m
```

### 验证3：速度与角速度关系

给定v = 1.0 m/s, L = 1.5 m, δ = 20° = 0.349 rad:
```
ω = (1.0 * tan(0.349)) / 1.5
  = (1.0 * 0.364) / 1.5
  ≈ 0.243 rad/s
```

---

## 参考文献

1. **Ackermann转向几何** - 经典车辆运动学理论
2. **非完整约束系统** - 机器人学基础
3. **车辆动力学** - 汽车工程教材

---

## 总结

Ackermann转向模型是4轮车的标准物理模型，相比简单的差分驱动模型：

1. **更准确**：考虑了轴距和转向角的物理约束
2. **更真实**：符合实际4轮车的转向机制
3. **更安全**：可以限制转向角，避免不合理的运动

在AGV控制中，使用Ackermann模型可以：
- 更准确地预测车辆轨迹
- 更好地规划路径
- 更安全地控制车辆运动

